name: Build Android TV APK

on:
  # æ‰‹åŠ¨è§¦å‘æž„å»º
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
  # è‡ªåŠ¨æž„å»ºè§¦å‘å™¨
  push:
    # å½“æŽ¨é€tagæ—¶æž„å»ºreleaseç‰ˆæœ¬
    tags:
      - 'v*'
    # å½“æŽ¨é€åˆ°masteråˆ†æ”¯æ—¶æž„å»ºdebugç‰ˆæœ¬
    branches:
      - master
    paths-ignore:
      - 'README.md'
      - 'docs/**'

permissions:
  contents: write

jobs:
  build:
    name: Build Android TV APK
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ— Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: yarn

      - name: ðŸ— Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: ðŸ— Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ— Cache Gradle dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ“¦ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ðŸ”§ Get version from package.json
        id: package-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: ðŸ”§ Determine build type
        id: build-config
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            BUILD_TYPE="${{ inputs.build_type }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            BUILD_TYPE="release"
          else
            BUILD_TYPE="debug"
          fi
          echo "build_type=$BUILD_TYPE" >> $GITHUB_OUTPUT
          echo "Building $BUILD_TYPE version..."

      - name: ðŸ›  Prebuild TV App
        run: yarn prebuild-tv

      - name: ðŸ”§ Make gradlew executable
        run: chmod +x android/gradlew

      - name: ðŸš€ Build APK (${{ steps.build-config.outputs.build_type }})
        run: |
          cd android
          if [[ "${{ steps.build-config.outputs.build_type }}" == "release" ]]; then
            ./gradlew assembleRelease
            APK_PATH="app/build/outputs/apk/release/app-release.apk"
          else
            ./gradlew assembleDebug
            APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
          fi
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
        id: build

      - name: ðŸ“± Prepare artifacts
        run: |
          mkdir -p artifacts
          BUILD_TYPE="${{ steps.build-config.outputs.build_type }}"
          VERSION="${{ steps.package-version.outputs.version }}"
          
          if [[ "$BUILD_TYPE" == "release" ]]; then
            APK_NAME="orionTV.v${VERSION}.apk"
            cp android/app/build/outputs/apk/release/app-release.apk "artifacts/${APK_NAME}"
          else
            COMMIT_SHORT=$(git rev-parse --short HEAD)
            APK_NAME="orionTV.v${VERSION}-debug-${COMMIT_SHORT}.apk"
            cp android/app/build/outputs/apk/debug/app-debug.apk "artifacts/${APK_NAME}"
          fi
          
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæž„å»ºä¿¡æ¯
          cat > artifacts/build-info.txt << EOF
          OrionTV Build Information
          ========================
          Version: $VERSION
          Build Type: $BUILD_TYPE
          Commit: $(git rev-parse HEAD)
          Branch: ${{ github.ref_name }}
          Build Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}
          EOF
        id: artifacts

      - name: ðŸ“¤ Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: OrionTV-${{ steps.build-config.outputs.build_type }}-v${{ steps.package-version.outputs.version }}
          path: artifacts/
          retention-days: 30

      - name: ðŸ· Create Release (Release builds only)
        if: steps.build-config.outputs.build_type == 'release'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.package-version.outputs.version }}
          name: OrionTV v${{ steps.package-version.outputs.version }}
          body: |
            ## ðŸŽ‰ OrionTV v${{ steps.package-version.outputs.version }}
            
            ### ðŸ“± ä¸‹è½½
            - [OrionTV APK](${{ steps.artifacts.outputs.apk_name }}) - Android TVç‰ˆæœ¬
            
            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - ðŸŽ¬ ç”µå½±å’Œç”µè§†å‰§æ’­æ”¾
            - âš¡ å¿«è¿›/å¿«é€€åŠŸèƒ½ (10ç§’é—´éš”)
            - ðŸŽšï¸ æ’­æ”¾é€Ÿåº¦è°ƒèŠ‚ (0.75x-2.25x)
            - ðŸŽ¯ å¯æ‹–æ‹½è¿›åº¦æ¡
            - ðŸ“± å“åº”å¼å¸ƒå±€è®¾è®¡
            - ðŸ“º TVç•Œé¢ä¼˜åŒ–
            
            ### ðŸ”§ æŠ€æœ¯è§„æ ¼
            - React Native TV OS
            - Expo 51
            - TypeScript
            - ZustandçŠ¶æ€ç®¡ç†
            
            > æž„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            > æž„å»ºID: ${{ github.run_id }}
          draft: false
          prerelease: false
          files: |
            artifacts/${{ steps.artifacts.outputs.apk_name }}
            artifacts/build-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ’¬ Build Summary
        run: |
          echo "## ðŸŽ‰ æž„å»ºå®Œæˆ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| å‚æ•° | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${{ steps.package-version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æž„å»ºç±»åž‹ | ${{ steps.build-config.outputs.build_type }} |" >> $GITHUB_STEP_SUMMARY
          echo "| APKæ–‡ä»¶ | ${{ steps.artifacts.outputs.apk_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æäº¤ID | $(git rev-parse --short HEAD) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ ä¸‹è½½APK" >> $GITHUB_STEP_SUMMARY
          echo "è¯·å‰å¾€ [Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ä¸‹è½½æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
